{% extends "base/base.html" %}
{% load static %}
{% block title %}QuickNav — In-App Navigation{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
<style>
    :root {
        --nav-primary: #6C3CE1;
        --nav-success: #10b981;
        --nav-danger: #ef4444;
        --nav-dark: #1a1b1e;
        --glass-bg: rgba(26, 27, 30, 0.9);
    }

    .main-content {
        padding-bottom: 0;
    }

    #driverMap {
        height: calc(100vh - 70px);
        width: 100%;
        border-radius: 0;
        z-index: 1;
    }

    .nav-overlay {
        position: fixed;
        right: 20px;
        top: 90px;
        width: 360px;
        max-height: calc(100vh - 120px);
        z-index: 1000;
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        box-shadow: 0 15px 45px rgba(0, 0, 0, 0.4);
        display: flex;
        flex-direction: column;
        transition: all 0.3s ease;
    }

    .nav-header {
        padding: 16px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .nav-body {
        padding: 16px;
        overflow-y: auto;
        flex-grow: 1;
        scrollbar-width: thin;
        scrollbar-color: var(--nav-primary) transparent;
    }

    .route-card {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 14px;
        padding: 14px;
        margin-bottom: 12px;
        position: relative;
        transition: all 0.2s ease;
        border-left: 4px solid transparent;
    }

    .route-card.active {
        border-color: var(--nav-primary);
        border-left-color: var(--nav-primary);
        background: rgba(108, 60, 225, 0.12);
        box-shadow: 0 0 15px rgba(108, 60, 225, 0.1);
    }

    .step-indicator {
        width: 24px;
        height: 24px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: white;
    }

    .instr-item {
        padding: 8px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        font-size: 0.8rem;
        color: #ddd;
    }

    .instr-item:last-child {
        border: none;
    }

    .btn-nav-action {
        background: var(--nav-primary);
        color: white !important;
        border-radius: 10px;
        font-weight: 600;
        font-size: 0.75rem;
        border: none;
        padding: 8px 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition: all 0.2s;
        text-decoration: none !important;
    }

    .btn-nav-action:hover {
        filter: brightness(1.1);
        transform: translateY(-1px);
    }

    .btn-nav-action.btn-secondary {
        background: rgba(255, 255, 255, 0.1);
    }

    .btn-gmaps {
        background: #4285F4;
        color: white !important;
    }

    .leaflet-routing-container {
        display: none !important;
    }

    @media (max-width: 768px) {
        .nav-overlay {
            width: calc(100% - 40px);
            left: 20px;
            right: 20px;
            bottom: 20px;
            top: auto;
            max-height: 40vh;
        }
    }

    .status-text {
        font-size: 0.65rem;
        text-transform: uppercase;
        font-weight: 800;
        letter-spacing: 0.5px;
    }

    #gps-warning {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 2000;
        display: none;
    }
</style>
{% endblock %}

{% block navbar %}{% include "base/sidebar_driver.html" %}{% endblock %}

{% block content %}
<div id="driverMap"></div>

<div id="gps-warning" class="alert alert-warning shadow-lg border-0 rounded-pill px-4">
    <i class="fa fa-satellite-dish me-2"></i>Waiting for GPS signal...
</div>

<div class="nav-overlay">
    <div class="nav-header">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="fw-bold m-0"><i class="fa fa-location-arrow me-2 text-primary"></i>QuickNav Live</h6>
            <span class="badge bg-success" id="overall-dist" style="font-size: 0.7rem">Locating...</span>
        </div>
    </div>

    <div class="nav-body">
        {% for b in bookings %}
        <!-- Pickup Card -->
        <div class="route-card active" id="card-pickup-{{ b.booking_id }}">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div class="d-flex gap-3">
                    <div class="step-indicator bg-primary"><i class="fa fa-box"></i></div>
                    <div>
                        <div class="status-text text-primary">Pickup Phase</div>
                        <div class="fw-bold" style="font-size: 0.9rem">{{ b.booking_id }}</div>
                    </div>
                </div>
                <a href="https://www.google.com/maps/dir/?api=1&destination={{ b.pickup_lat|default:0 }},{{ b.pickup_lng|default:0 }}"
                    target="_blank" class="btn-nav-action btn-gmaps py-1 px-2" style="font-size: 0.65rem">
                    <i class="fab fa-google"></i>
                </a>
            </div>

            <div class="small text-white-50 mb-3">
                <i class="fa fa-map-marker-alt me-2 text-primary"></i>{{ b.pickup_address }}
            </div>

            <div id="instr-pickup-{{ b.booking_id }}" class="mb-3 d-none">
                <div class="text-muted small">Calculating route...</div>
            </div>

            <div class="d-flex gap-2">
                <button class="btn-nav-action w-100"
                    onclick="setDestination({{ b.pickup_lat|default:0 }}, {{ b.pickup_lng|default:0 }}, 'PICKUP', 'pickup-{{ b.booking_id }}', '{{ b.pickup_address|escapejs }}')">
                    <i class="fa fa-play"></i> In-App Nav
                </button>
                <button class="btn-nav-action btn-secondary"
                    onclick="focusTask({{ b.pickup_lat|default:0 }}, {{ b.pickup_lng|default:0 }})">
                    <i class="fa fa-crosshairs"></i>
                </button>
            </div>

            {% if b.status == 'confirmed' %}
            <div class="mt-3">
                <a href="{% url 'mark_as_picked_up' b.booking_id %}" class="btn-nav-action w-100 py-2"
                    style="background:var(--nav-success)">
                    <i class="fa fa-box-open"></i> Confirm Picked Up
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Drop Cards -->
        {% for drop in b.drop_locations.all %}
        <div class="route-card" id="card-drop-{{ drop.id }}">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div class="d-flex gap-3">
                    <div class="step-indicator bg-danger"><i class="fa fa-home"></i></div>
                    <div>
                        <div class="status-text text-danger">Delivery Phase</div>
                        <div class="fw-bold" style="font-size: 0.85rem">{{ drop.recipient_name }}</div>
                    </div>
                </div>
                <a href="https://www.google.com/maps/dir/?api=1&destination={{ drop.lat|default:0 }},{{ drop.lng|default:0 }}"
                    target="_blank" class="btn-nav-action btn-gmaps py-1 px-2" style="font-size: 0.65rem">
                    <i class="fab fa-google"></i>
                </a>
            </div>

            <div class="small text-white-50 mb-3">
                <i class="fa fa-user-circle me-2"></i>{{ drop.recipient_phone }}<br>
                <i class="fa fa-map-pin me-2 text-danger"></i>{{ drop.address|truncatechars:50 }}
            </div>

            <div id="instr-drop-{{ drop.id }}" class="mb-3 d-none">
                <div class="text-muted small">Calculating route...</div>
            </div>

            <div class="d-flex gap-2">
                <button class="btn-nav-action w-100" style="background:var(--nav-danger)"
                    onclick="setDestination({{ drop.lat|default:0 }}, {{ drop.lng|default:0 }}, 'DROP', 'drop-{{ drop.id }}', '{{ drop.address|escapejs }}')">
                    <i class="fa fa-route"></i> Reach Customer
                </button>
                <button class="btn-nav-action btn-secondary"
                    onclick="focusTask({{ drop.lat|default:0 }}, {{ drop.lng|default:0 }})">
                    <i class="fa fa-crosshairs"></i>
                </button>
            </div>

            {% if drop.status == 'pending' and b.status == 'picked_up' or b.status == 'in_transit' %}
            <div class="mt-3">
                <a href="{% url 'mark_drop_delivered' drop.id %}" class="btn-nav-action w-100 py-2"
                    style="background:var(--nav-success)">
                    <i class="fa fa-check-double"></i> Mark Delivered
                </a>
            </div>
            {% elif drop.status == 'delivered' %}
            <div class="mt-3">
                <button class="btn-nav-action w-100 py-2 border-0 bg-success opacity-50" disabled>
                    <i class="fa fa-check-circle"></i> Completed
                </button>
            </div>
            {% endif %}
        </div>
        {% endfor %}

        {% empty %}
        <div class="text-center py-5">
            <i class="fa fa-map fa-3x mb-3 opacity-10"></i>
            <p class="text-muted">No active tasks</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% load static %}
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
<script>
    (function () {
        const map = L.map('driverMap', { zoomControl: false }).setView([20.5937, 78.9629], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);

        let driverPos = null;
        let driverMarker = null;
        let routingControl = null;
        let currentDest = null;
        let isFirstLocation = true;

        // Safety check for API instance
        if (typeof window.PlaceAutocomplete !== 'undefined' && !window.autocompleteApiInstance) {
            window.autocompleteApiInstance = new PlaceAutocomplete('d5683c70aamsh865e63a743fd600p16939djsn74e97e3dd84f');
        }

        const driverIcon = L.divIcon({
            className: '',
            html: '<div style="background:var(--nav-primary);border:2px solid white;border-radius:50%;width:20px;height:20px;box-shadow:0 0 15px var(--nav-primary)"></div>'
        });

        window.focusTask = function (lat, lng) {
            if (lat && lng && lat !== "0" && lat !== 0) {
                map.setView([parseFloat(lat), parseFloat(lng)], 17);
            }
        };

        window.setDestination = function (lat, lng, type, elementId, addressFallback) {
            console.log("Setting Dest:", { lat, lng, type, elementId });

            if ((!lat || lat === 0 || lat === "0") && addressFallback) {
                const distEl = document.getElementById('overall-dist');
                if (distEl) distEl.textContent = "Locating via Google...";

                // Use the new Google fallback
                window.autocompleteApiInstance.geocodeAddress(addressFallback).then(details => {
                    if (details && details.lat) {
                        window.setDestination(details.lat, details.lng, type, elementId, null);
                    } else {
                        // Final fallback to Nominatim if Google somehow fails
                        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addressFallback)}`)
                            .then(res => res.json())
                            .then(data => {
                                if (data && data.length > 0) {
                                    window.setDestination(parseFloat(data[0].lat), parseFloat(data[0].lon), type, elementId, null);
                                } else {
                                    if (distEl) distEl.textContent = "Location Not Found";
                                    alert("Could not locate address. Please try the Google Maps button.");
                                }
                            });
                    }
                }).catch(() => {
                    if (distEl) distEl.textContent = "Error Locating";
                });
                return;
            }

            if (!lat || lat === 0 || lat === "0") {
                alert("Destination coordinates unavailable.");
                return;
            }

            currentDest = { lat: parseFloat(lat), lng: parseFloat(lng), type, id: elementId };

            // UI Updates
            document.querySelectorAll('.route-card').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('[id^="instr-"]').forEach(i => i.classList.add('d-none'));

            const activeCard = document.getElementById('card-' + elementId);
            const activeInstr = document.getElementById('instr-' + elementId);
            if (activeCard) activeCard.classList.add('active');
            if (activeInstr) activeInstr.classList.remove('d-none');

            updateRoute();
        };

        function updateRoute() {
            if (!driverPos || !currentDest) return;

            if (routingControl) map.removeControl(routingControl);

            routingControl = L.Routing.control({
                waypoints: [driverPos, L.latLng(currentDest.lat, currentDest.lng)],
                routeWhileDragging: false,
                addWaypoints: false,
                showAlternatives: false,
                draggableWaypoints: false,
                lineOptions: {
                    styles: [{ color: currentDest.type === 'PICKUP' ? '#6C3CE1' : '#ef4444', weight: 8, opacity: 0.8 }]
                },
                createMarker: function (i, wp) {
                    if (i === 1) return L.marker(wp.latLng, {
                        icon: L.divIcon({
                            className: '',
                            html: `<div style="background:${currentDest.type === 'PICKUP' ? '#10b981' : '#ef4444'};padding:4px 8px;border-radius:6px;color:white;font-weight:bold;font-size:9px;box-shadow:0 2px 6px rgba(0,0,0,0.3)">${currentDest.type}</div>`
                        })
                    });
                    return null;
                }
            }).addTo(map);

            routingControl.on('routesfound', function (e) {
                const routes = e.routes;
                const summary = routes[0].summary;
                const distEl = document.getElementById('overall-dist');
                if (distEl) distEl.textContent = (summary.totalDistance / 1000).toFixed(1) + ' km away';

                const instrContainer = document.getElementById('instr-' + currentDest.id);
                if (instrContainer) {
                    instrContainer.innerHTML = '<h6 class="small fw-bold mb-2">Live Directions</h6>';
                    routes[0].instructions.slice(0, 4).forEach(step => {
                        const div = document.createElement('div');
                        div.className = 'instr-item';
                        div.innerHTML = `<i class="fa fa-chevron-right me-2 text-primary" style="font-size: 0.6rem"></i>${step.text} <span class="text-muted">(${Math.round(step.distance)}m)</span>`;
                        instrContainer.appendChild(div);
                    });
                }

                // Auto-zoom to fit the route
                const bounds = L.latLngBounds([driverPos, [currentDest.lat, currentDest.lng]]);
                map.fitBounds(bounds, { padding: [100, 100], maxZoom: 16 });
            });
        }

        function initNavigation() {
            const warningEl = document.getElementById('gps-warning');
            if (warningEl) warningEl.style.display = 'block';

            if (!navigator.geolocation) {
                alert("Geolocation not supported by your browser.");
                return;
            }

            navigator.geolocation.watchPosition(pos => {
                if (warningEl) warningEl.style.display = 'none';

                const { latitude: lat, longitude: lng } = pos.coords;
                driverPos = L.latLng(lat, lng);

                if (!driverMarker) {
                    driverMarker = L.marker(driverPos, { icon: driverIcon }).addTo(map);
                    if (isFirstLocation) {
                        map.setView(driverPos, 16);
                        isFirstLocation = false;

                        // Auto-start first pickup if available
                        const firstPickup = document.querySelector('[onclick^="setDestination"]');
                        if (firstPickup) {
                            firstPickup.click();
                        }
                    }
                } else {
                    driverMarker.setLatLng(driverPos);
                    if (currentDest) updateRoute();
                }
            }, err => {
                console.error("GPS Error:", err);
                if (warningEl) warningEl.innerHTML = '<i class="fa fa-exclamation-triangle me-2"></i>GPS access denied/failed.';
            }, { enableHighAccuracy: true });
        }

        initNavigation();
    })();
</script>
{% endblock %}