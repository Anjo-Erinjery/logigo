{% extends "base/base.html" %}
{% block title %}Track {{ booking.booking_id }} â€” Deliver{% endblock %}
{% block navbar %}{% include "base/sidebar_customer.html" %}{% endblock %}
{% block content %}
<div class="topbar">
    <span class="topbar-title"><i class="fa fa-satellite me-2" style="color:var(--success)"></i>Live Tracking â€” {{ booking.booking_id }}</span>
    <div class="topbar-user">
        <span class="status-badge status-{{ booking.status }}">{{ booking.get_status_display }}</span>
    </div>
</div>
<div class="container-fluid py-4">
    <div class="row g-4">
        <div class="col-lg-8">
            <div class="dash-card p-0 overflow-hidden">
                <div id="trackingMap" style="height:500px;"></div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="dash-card mb-3">
                <h6 class="fw-bold mb-3">Delivery Details</h6>
                <div class="mb-2 small"><span class="text-muted">Booking ID</span><br><strong>{{ booking.booking_id }}</strong></div>
                <div class="mb-2 small"><span class="text-muted">Pickup</span><br>{{ booking.pickup_address }}</div>
                <div class="mb-2 small"><span class="text-muted">Driver</span><br>
                    {% if booking.driver %}{{ booking.driver.get_full_name }}{% else %}<span
                        class="text-muted">Assigning...</span>{% endif %}
                </div>
                <div class="small"><span class="text-muted">Price</span><br><strong>â‚¹{{ booking.total_price }}</strong>
                </div>
            </div>

            <!-- Drop locations -->
            <div class="dash-card mb-3">
                <h6 class="fw-bold mb-3">Drop Locations</h6>
                {% for drop in drops %}
                <div class="drop-card mb-2">
                    <div class="small fw-bold mb-1">Drop {{ drop.sequence_order }} â€” {{ drop.recipient_name }}</div>
                    <div class="small text-muted">{{ drop.address|truncatechars:50 }}</div>
                    <span class="status-badge status-{{ drop.status }} mt-1 d-inline-block">{{ drop.get_status_display }}</span>
                </div>
                {% endfor %}
            </div>

            <!-- Tracking timeline -->
            <div class="dash-card">
                <h6 class="fw-bold mb-3">Tracking Updates</h6>
                <div class="tracking-timeline">
                    {% for u in updates %}
                    <div class="tracking-step">
                        <div class="small fw-semibold">{{ u.status_message }}</div>
                        <div class="small text-muted">{{ u.timestamp|date:"d M, H:i" }}</div>
                    </div>
                    {% empty %}
                    <div class="small text-muted">No updates yet. Tracking starts once driver is assigned.</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
    const map = L.map('trackingMap').setView([{{ booking.pickup_lat |default:20.5937 }}, {{ booking.pickup_lng|default:78.9629 }}], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);

    // Pickup marker
    const pickup = L.marker([{{ booking.pickup_lat |default:20 }}, {{ booking.pickup_lng|default:79 }}], {
        icon: L.divIcon({ className: '', html: '<div style="background:var(--primary);color:white;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-size:14px;box-shadow:0 2px 8px rgba(0,0,0,.5)">ðŸ“¦</div>' })
    }).addTo(map).bindPopup('Pickup: {{ booking.pickup_address|escapejs }}');

    // Drop markers
    {% for drop in drops %}
    L.marker([{{ drop.lat |default:20.1 }}, {{ drop.lng |default:79.1 }}], {
        icon: L.divIcon({ className: '', html: '<div style="background:var(--accent);color:white;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-size:14px;box-shadow:0 2px 8px rgba(0,0,0,.5)">{{ drop.sequence_order }}</div>' })
    }).addTo(map).bindPopup('Drop {{ drop.sequence_order }}: {{ drop.address|escapejs }}');
    {% endfor %}

    // Live updates polling
    function pollUpdates() {
        fetch('/api/tracking/{{ booking.booking_id }}/')
            .then(r => r.json())
            .then(data => {
                if (data.lat && data.lng) {
                    map.setView([data.lat, data.lng], 14);
                }
            }).catch(() => { });
    }
    setInterval(pollUpdates, 15000);
</script>
{% endblock %}
